#!/bin/sh

echo "üöÄ Running pre-commit checks..."

FRONTEND_DIR="frontend"
BACKEND_DIR="backend"

cd "$FRONTEND_DIR" || {
    echo "‚ùå Cannot enter $FRONTEND_DIR directory"
    exit 1
}

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^$FRONTEND_DIR/.*\.\(ts\|tsx\|js\|jsx\)$" | sed "s|^$FRONTEND_DIR/||")

if [ "$STAGED_FILES" = "" ]; then
    echo "‚úÖ No frontend files to check"
    cd - > /dev/null
    exit 0
fi

echo "üìÅ Files to check:"
echo "$STAGED_FILES"

echo "üîß Running ESLint..."
npx eslint --fix $STAGED_FILES
if [ $? -ne 0 ]; then
    echo "‚ùå ESLint failed!"
    cd - > /dev/null
    exit 1
fi

echo "üé® Running Prettier..."
npx prettier --write $STAGED_FILES
if [ $? -ne 0 ]; then
    echo "‚ùå Prettier failed!"
    cd - > /dev/null
    exit 1
fi

echo "üìò Running TypeScript type check..."
npx tsc --build tsconfig.app.json tsconfig.node.json --noEmit
TSC_EXIT=$?
if [ $TSC_EXIT -ne 0 ]; then
    echo "‚ùå TypeScript type check failed!"
    echo "üí° Please fix the type errors above before committing."
    cd - > /dev/null
    exit 1
fi

cd - > /dev/null
git add $(echo "$STAGED_FILES" | sed "s|^|$FRONTEND_DIR/|")

# ---------- BACKEND ----------
echo "üêç Running Ruff lint on backend..."

STAGED_BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/.*\.py$")

if [ "$STAGED_BACKEND_FILES" != "" ]; then
  echo "üìÅ Python files to check:"
  echo "$STAGED_BACKEND_FILES"
  ruff check --fix backend || {
    echo "‚ùå Ruff linting failed!"
    exit 1
  }
  git add $(echo "$STAGED_BACKEND_FILES")
else
  echo "‚úÖ No backend Python files to check."
fi

echo "‚úÖ All checks passed! Committing..."
exit 0
